- name: Clean and Reg
name: Build APK Simple (admin/1234)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  build-flutter-apk:
    name: Build Flutter APK 
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get Dependencies
      working-directory: ./mobile
      run: |
        echo "📦 تحميل التبعيات..."
        flutter clean
        flutter pub get --no-version-check
        echo "✅ تم تحميل التبعيات"

    - name: Fix Navigation Safe Args Issue
      working-directory: ./mobile
      run: |
        echo "🔧 إصلاح مشكلة Safe Args في ملف التنقل..."
        
        # تثبيت xmlstarlet لمعالجة ملفات XML
        sudo apt-get update && sudo apt-get install -y xmlstarlet
        
        NAV_FILE="app/src/main/res/navigation/nav_graph.xml"
        
        if [ -f "$NAV_FILE" ]; then
            # إصلاح الوسائط التي تحتوي على defaultValue بدون type
            xmlstarlet ed -L \
                -i "//argument[@android:defaultValue='0' and not(@app:argType)]" -t attr -n "app:argType" -v "integer" \
                "$NAV_FILE"
            
            # بديل: استخدام sed للإصلاح البسيط
            sed -i 's/<argument android:name="[^"]*" android:defaultValue="0" *\/>/& app:argType="integer"/g' "$NAV_FILE"
            
            echo "✅ تم إصلاح ملف التنقل"
        else
            echo "⚠️ ملف nav_graph.xml غير موجود، تخطي الإصلاح"
        fi

    - name: Generate Keystore
      working-directory: ./mobile
      run: |
        echo "🔐 إنشاء مفتاح توقيع..."
        keytool -genkey -v \
          -keystore android/app/marina-hotel-key.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias marina-hotel \
          -dname "CN=Marina Hotel, OU=Mobile, O=Marina Hotel, L=Sana'a, C=YE" \
          -storepass marinahotel2024 \
          -keypass marinahotel2024 \
          -noprompt
        echo "✅ تم إنشاء المفتاح"

    - name: Create Key Properties
      working-directory: ./mobile
      run: |
        echo "🔑 إعداد ملف المفاتيح..."
        cat > android/key.properties << EOF
        storePassword=marinahotel2024
        keyPassword=marinahotel2024
        keyAlias=marina-hotel
        storeFile=marina-hotel-key.jks
        EOF
        echo "✅ تم إنشاء key.properties"

    - name: Build APK
      working-directory: ./mobile
      run: |
        echo "🚀 بناء APK موقع..."
        echo "بيانات الدخول المُكونة: admin/1234"
        
        # Build release APK with signing
        flutter build apk --release --no-tree-shake-icons
        
        echo "✅ تم بناء APK بنجاح!"
        echo "📱 معلومات الملفات:"
        ls -lh build/app/outputs/flutter-apk/

    # ... باقي الخطوات كما هي
