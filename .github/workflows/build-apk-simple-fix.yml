- name: Clean and Reg
name: Build APK Simple (admin/1234)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  build-flutter-apk:
    name: Build Flutter APK 
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get Dependencies
      working-directory: ./mobile
      run: |
        echo "ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª..."
        flutter clean
        flutter pub get --no-version-check
        echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª"

    - name: Fix Navigation Safe Args Issue
      working-directory: ./mobile
      run: |
        echo "ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Safe Args ÙÙŠ Ù…Ù„Ù Ø§Ù„ØªÙ†Ù‚Ù„..."
        
        # ØªØ«Ø¨ÙŠØª xmlstarlet Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª XML
        sudo apt-get update && sudo apt-get install -y xmlstarlet
        
        NAV_FILE="app/src/main/res/navigation/nav_graph.xml"
        
        if [ -f "$NAV_FILE" ]; then
            # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ defaultValue Ø¨Ø¯ÙˆÙ† type
            xmlstarlet ed -L \
                -i "//argument[@android:defaultValue='0' and not(@app:argType)]" -t attr -n "app:argType" -v "integer" \
                "$NAV_FILE"
            
            # Ø¨Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… sed Ù„Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø³ÙŠØ·
            sed -i 's/<argument android:name="[^"]*" android:defaultValue="0" *\/>/& app:argType="integer"/g' "$NAV_FILE"
            
            echo "âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ù„Ù Ø§Ù„ØªÙ†Ù‚Ù„"
        else
            echo "âš ï¸ Ù…Ù„Ù nav_graph.xml ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ®Ø·ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"
        fi

    - name: Generate Keystore
      working-directory: ./mobile
      run: |
        echo "ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ØªÙˆÙ‚ÙŠØ¹..."
        keytool -genkey -v \
          -keystore android/app/marina-hotel-key.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias marina-hotel \
          -dname "CN=Marina Hotel, OU=Mobile, O=Marina Hotel, L=Sana'a, C=YE" \
          -storepass marinahotel2024 \
          -keypass marinahotel2024 \
          -noprompt
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙØªØ§Ø­"

    - name: Create Key Properties
      working-directory: ./mobile
      run: |
        echo "ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­..."
        cat > android/key.properties << EOF
        storePassword=marinahotel2024
        keyPassword=marinahotel2024
        keyAlias=marina-hotel
        storeFile=marina-hotel-key.jks
        EOF
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ key.properties"

    - name: Build APK
      working-directory: ./mobile
      run: |
        echo "ğŸš€ Ø¨Ù†Ø§Ø¡ APK Ù…ÙˆÙ‚Ø¹..."
        echo "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙÙƒÙˆÙ†Ø©: admin/1234"
        
        # Build release APK with signing
        flutter build apk --release --no-tree-shake-icons
        
        echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª:"
        ls -lh build/app/outputs/flutter-apk/

    # ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙƒÙ…Ø§ Ù‡ÙŠ
