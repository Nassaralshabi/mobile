# Version Bump Workflow
# Ù„Ø²ÙŠØ§Ø¯Ø© Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Ù†ÙˆØ¹ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± / Version bump type'
        required: true
        type: choice
        options:
          - patch  # 1.0.0 -> 1.0.1
          - minor  # 1.0.0 -> 1.1.0
          - major  # 1.0.0 -> 2.0.0
        default: 'patch'
      custom_version:
        description: 'Ø¥ØµØ¯Ø§Ø± Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) / Custom version (optional, e.g. 2.5.3)'
        required: false
        type: string

jobs:
  bump-version:
    name: ğŸ”¢ Bump Version Number
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ”¢ Calculate New Version
        id: version
        working-directory: ./mobile
        run: |
          # Get current version from pubspec.yaml
          CURRENT_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "Current version: $CURRENT_VERSION"
          
          # Extract version name and build number
          VERSION_NAME=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          
          echo "Version name: $VERSION_NAME"
          echo "Build number: $BUILD_NUMBER"
          
          # Check if custom version is provided
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION_NAME="${{ github.event.inputs.custom_version }}"
            echo "ğŸ“ Using custom version: $NEW_VERSION_NAME"
          else
            # Parse version components
            MAJOR=$(echo $VERSION_NAME | cut -d'.' -f1)
            MINOR=$(echo $VERSION_NAME | cut -d'.' -f2)
            PATCH=$(echo $VERSION_NAME | cut -d'.' -f3)
            
            echo "Current components - Major: $MAJOR, Minor: $MINOR, Patch: $PATCH"
            
            # Increment based on type
            case "${{ github.event.inputs.version_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                echo "ğŸš€ Bumping MAJOR version"
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                echo "âœ¨ Bumping MINOR version"
                ;;
              patch)
                PATCH=$((PATCH + 1))
                echo "ğŸ”§ Bumping PATCH version"
                ;;
            esac
            
            NEW_VERSION_NAME="${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          # Increment build number
          NEW_BUILD=$((BUILD_NUMBER + 1))
          NEW_VERSION="${NEW_VERSION_NAME}+${NEW_BUILD}"
          
          echo "âœ… New version: $NEW_VERSION"
          echo "   Version name: $NEW_VERSION_NAME"
          echo "   Build number: $NEW_BUILD"
          
          # Export for next steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version_name=$NEW_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "new_build_number=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ“ Update pubspec.yaml
        working-directory: ./mobile
        run: |
          echo "Updating version in pubspec.yaml..."
          sed -i "s/^version: .*/version: ${{ steps.version.outputs.new_version }}/" pubspec.yaml
          
          # Verify the change
          NEW_VERSION_CHECK=$(grep "^version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')
          if [ "$NEW_VERSION_CHECK" = "${{ steps.version.outputs.new_version }}" ]; then
            echo "âœ… Version updated successfully to $NEW_VERSION_CHECK"
          else
            echo "âŒ Version update failed!"
            exit 1
          fi

      - name: ğŸ“‹ Generate Changelog Entry
        run: |
          # Create changelog entry
          DATE=$(date +"%Y-%m-%d")
          
          cat > version_changelog.md << EOF
          ## Version ${{ steps.version.outputs.new_version_name }} (Build ${{ steps.version.outputs.new_build_number }}) - $DATE
          
          ### Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª / Changes:
          - ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† ${{ steps.version.outputs.old_version }} Ø¥Ù„Ù‰ ${{ steps.version.outputs.new_version }}
          - Version bumped from ${{ steps.version.outputs.old_version }} to ${{ steps.version.outputs.new_version }}
          
          ### Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« / Update Type:
          - **${{ github.event.inputs.version_type }}** version bump
          
          ---
          EOF
          
          echo "ğŸ“‹ Changelog entry created"
          cat version_changelog.md

      - name: ğŸ’¾ Commit Changes
        run: |
          git add mobile/pubspec.yaml
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}

          - Updated from ${{ steps.version.outputs.old_version }} to ${{ steps.version.outputs.new_version }}
          - Version type: ${{ github.event.inputs.version_type }}
          - Build number: ${{ steps.version.outputs.new_build_number }}
          
          ğŸ¤– Automated version bump by GitHub Actions"
          
          echo "âœ… Changes committed"

      - name: ğŸš€ Create Version Branch
        run: |
          BRANCH_NAME="version-bump-${{ steps.version.outputs.new_version_name }}-${{ github.run_number }}"
          git checkout -b $BRANCH_NAME
          git push origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Branch created: $BRANCH_NAME"
        id: branch

      - name: ğŸ”€ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ steps.version.outputs.new_version }}"
          branch: version-bump-${{ steps.version.outputs.new_version_name }}-${{ github.run_number }}
          title: "ğŸ”¢ Version Bump: ${{ steps.version.outputs.old_version }} â†’ ${{ steps.version.outputs.new_version }}"
          body: |
            ## ğŸ”¢ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± / Version Bump
            
            ### ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± / Version Information:
            - **Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ / Previous Version:** `${{ steps.version.outputs.old_version }}`
            - **Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ / New Version:** `${{ steps.version.outputs.new_version }}`
            - **Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« / Bump Type:** `${{ github.event.inputs.version_type }}`
            - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ / Build Number:** `${{ steps.version.outputs.new_build_number }}`
            
            ### ğŸ“ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª / Changes:
            - ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù `pubspec.yaml` Ø¨Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            - Updated `pubspec.yaml` with new version number
            
            ### âœ… Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© / Next Steps:
            1. ğŸ” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª / Review the changes
            2. âœ… ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù€ PR / Approve the PR
            3. ğŸ”€ Ø§Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ / Merge to main branch
            4. ğŸ·ï¸ Ø£Ù†Ø´Ø¦ tag Ø¬Ø¯ÙŠØ¯: `v${{ steps.version.outputs.new_version_name }}`
            5. ğŸš€ Ù‚Ù… Ø¨Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© / Release new version
            
            ---
            
            ğŸ¤– ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù€ PR ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© GitHub Actions
            ğŸ¤– This PR was automatically created by GitHub Actions
          labels: |
            version-bump
            automated
          draft: false

      - name: ğŸ“Š Summary
        run: |
          echo "## ğŸ‰ Version Bump Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Version Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** \`${{ steps.version.outputs.old_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version:** \`${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Name:** \`${{ steps.version.outputs.new_version_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** \`${{ steps.version.outputs.new_build_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Bump Type:** \`${{ github.event.inputs.version_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the automatically created Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "2. Create a git tag: \`v${{ steps.version.outputs.new_version_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Trigger a release build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¨ **Marina Hotel Mobile App**" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: âœ… Notify Success
    runs-on: ubuntu-latest
    needs: bump-version
    if: success()
    
    steps:
      - name: Success Message
        run: |
          echo "ğŸ‰ Version bump completed successfully!"
          echo "âœ… Pull request created for review"
          echo "ğŸ¨ Marina Hotel app version updated"

  notify-failure:
    name: âŒ Notify Failure
    runs-on: ubuntu-latest
    needs: bump-version
    if: failure()
    
    steps:
      - name: Failure Message
        run: |
          echo "âŒ Version bump failed!"
          echo "ğŸ” Please check the logs for errors"
          echo "ğŸ’¡ Common issues: permissions, invalid version format"
