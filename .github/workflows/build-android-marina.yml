name: Build Android Marina App

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'app-marina/**'
      - '.github/workflows/build-android-marina.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'app-marina/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      version_name:
        description: 'Version name (optional)'
        required: false
        type: string

env:
  JAVA_VERSION: '17'

jobs:
  build-android-marina:
    name: Build Android Marina APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        cmake-version: latest
        ndk-version: latest

    - name: Cache Gradle Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Create Keystore for Signing
      working-directory: ./app-marina
      run: |
        echo "ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ØªÙˆÙ‚ÙŠØ¹ Ù„ØªØ·Ø¨ÙŠÙ‚ Marina Hotel..."
        keytool -genkey -v \
          -keystore app/marina-hotel-key.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias marina-hotel \
          -dname "CN=Marina Hotel, OU=IT Department, O=Marina Hotel, L=Sana'a, ST=Sana'a, C=YE" \
          -storepass marinahotel2024 \
          -keypass marinahotel2024 \
          -noprompt
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­"

    - name: Create Signing Configuration
      working-directory: ./app-marina
      run: |
        echo "ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹..."
        cat > app/keystore.properties << EOF
        storePassword=marinahotel2024
        keyPassword=marinahotel2024
        keyAlias=marina-hotel
        storeFile=marina-hotel-key.jks
        EOF
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"

    - name: Update Build Config for Admin Credentials
      working-directory: ./app-marina
      run: |
        echo "ğŸ”§ ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª admin/1234 ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
        echo "âœ… ØªÙ… ØªÙƒÙˆÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: admin/1234"
        echo "âœ… Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚"

    - name: Make Gradlew Executable
      working-directory: ./app-marina
      run: |
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø°ÙˆÙ†Ø§Øª gradlew"
        else
          echo "âš ï¸ gradlew ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… gradle"
        fi

    - name: Build Debug APK
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
      working-directory: ./app-marina
      run: |
        echo "ğŸ”¨ Ø¨Ù†Ø§Ø¡ APK ØªØ¬Ø±ÙŠØ¨ÙŠ..."
        if [ -f "gradlew" ]; then
          ./gradlew assembleDebug --stacktrace --info
        else
          gradle assembleDebug --stacktrace --info
        fi
        echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­"
        
    - name: Build Release APK
      if: ${{ github.event.inputs.build_type == 'release' || github.event.inputs.build_type == '' }}
      working-directory: ./app-marina
      run: |
        echo "ğŸ”¨ Ø¨Ù†Ø§Ø¡ APK Ù†Ù‡Ø§Ø¦ÙŠ Ù…ÙˆÙ‚Ø¹..."
        if [ -f "gradlew" ]; then
          ./gradlew assembleRelease --stacktrace --info
        else
          gradle assembleRelease --stacktrace --info
        fi
        echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­"

    - name: Validate Build Outputs
      working-directory: ./app-marina
      run: |
        echo "ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙØ§Øª APK Ø§Ù„Ù…ÙÙ†ØªØ¬Ø©..."
        BUILD_DIR="app/build/outputs/apk"
        
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
          exit 1
        fi
        
        if [ -z "$(find $BUILD_DIR -name '*.apk')" ]; then
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†ØªØ§Ø¬ Ø£ÙŠ Ù…Ù„Ù APK!"
          exit 1
        fi
        
        echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙØ§Øª APK Ø¨Ù†Ø¬Ø§Ø­"
        echo "ğŸ“± Ù…Ù„ÙØ§Øª APK Ø§Ù„Ù…ÙÙ†ØªØ¬Ø©:"
        find $BUILD_DIR -name "*.apk" -exec ls -lh {} \;

    - name: Prepare APK Files for Download
      working-directory: ./app-marina
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ù…Ø®Ø±Ø¬Ø§Øª
        mkdir -p ../marina-android-apk-output
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        if [ -z "$VERSION_NAME" ]; then
          VERSION_NAME="1.0"
        fi
        
        BUILD_NUMBER=$GITHUB_RUN_NUMBER
        DATE=$(date +%Y%m%d)
        COMMIT_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
        
        echo "ğŸ·ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:"
        echo "- Ø§Ù„Ø¥ØµØ¯Ø§Ø±: $VERSION_NAME"
        echo "- Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_NUMBER" 
        echo "- Ø§Ù„ØªØ§Ø±ÙŠØ®: $DATE"
        echo "- Commit: $COMMIT_SHORT"
        
        # Ù†Ø³Ø® ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ù…Ù„ÙØ§Øª APK
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp "app/build/outputs/apk/debug/app-debug.apk" "../marina-android-apk-output/marina-hotel-android-v${VERSION_NAME}-debug-${DATE}-${BUILD_NUMBER}.apk"
          echo "âœ… ØªÙ… Ù†Ø³Ø® APK Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ"
        fi
        
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          cp "app/build/outputs/apk/release/app-release.apk" "../marina-android-apk-output/marina-hotel-android-v${VERSION_NAME}-release-${DATE}-${BUILD_NUMBER}.apk"
          echo "âœ… ØªÙ… Ù†Ø³Ø® APK Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"
        fi

    - name: Generate APK Info File
      run: |
        cd marina-android-apk-output
        cat > BUILD_INFO.md << EOF
        # Marina Hotel Android App - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡

        ## ğŸ¨ ØªØ·Ø¨ÙŠÙ‚ ÙÙ†Ø¯Ù‚ Ù…Ø§Ø±ÙŠÙ†Ø§ - Android (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        
        ### ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
        - **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡:** $(date)
        - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:** $GITHUB_RUN_NUMBER
        - **Commit SHA:** $GITHUB_SHA
        - **Ø§Ù„ÙØ±Ø¹:** $GITHUB_REF_NAME
        - **Java Version:** ${{ env.JAVA_VERSION }}
        
        ### ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙÙƒÙˆÙ†Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹:
        - **Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:** admin
        - **ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:** 1234
        
        ### ğŸ“± Ù…Ù„ÙØ§Øª APK:
        EOF
        
        for file in *.apk; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            echo "- **$file** (${SIZE})" >> BUILD_INFO.md
          fi
        done
        
        cat >> BUILD_INFO.md << EOF
        
        ### ğŸ”§ Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:
        - âœ… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„ØºØ±Ù
        - âœ… Ù†Ø¸Ø§Ù… Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…ØªÙƒØ§Ù…Ù„  
        - âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        - âœ… ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø§Ù„ÙŠØ© Ù…ÙØµÙ„Ø©
        - âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ø¢Ù…Ù†Ø©
        - âœ… ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        - âœ… Ù…Ø³ØªØ®Ø¯Ù… admin Ù…ÙÙ‡ÙŠØ£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        
        ### ğŸ“² ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª:
        1. Ø­Ù…Ù„ Ù…Ù„Ù APK
        2. ÙØ¹Ù‘Ù„ "ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
        3. Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        4. Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªØ®Ø¯Ù… admin/1234 Ù„Ù„Ø¯Ø®ÙˆÙ„
        5. Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø¥Ø¯Ø§Ø±Ø© ÙÙ†Ø¯Ù‚Ùƒ! ğŸ¨
        
        ### ğŸ—„ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
        - ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… admin ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
        - ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ÙØ´ÙØ±Ø© Ø¨Ù€ Salt + SHA-256
        - Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Room Ù…Ø­Ù„ÙŠØ© Ø¢Ù…Ù†Ø©
        
        ---
        
        **ØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ø¨Ù€ â¤ï¸ Ù„ÙÙ†Ø¯Ù‚ Ù…Ø§Ø±ÙŠÙ†Ø§**
        EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡"

    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: marina-hotel-android-apk-${{ github.run_number }}
        path: marina-android-apk-output/
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: marina-android-apk-output/*.apk
        body_path: marina-android-apk-output/BUILD_INFO.md
        name: Marina Hotel Android v${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment APK Download Links (on PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const apkDir = 'marina-android-apk-output';
          if (fs.existsSync(apkDir)) {
            const files = fs.readdirSync(apkDir).filter(f => f.endsWith('.apk'));
            
            let comment = '## ğŸ“± Marina Hotel Android APK Ø¬Ø§Ù‡Ø²!\n\n';
            comment += `**Build #${context.runNumber}** ØªÙ… Ø¨Ù†Ø¬Ø§Ø­.\n\n`;
            comment += '### ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:\n';
            comment += '- **Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:** admin\n';
            comment += '- **ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:** 1234\n\n';
            comment += '### ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª APK:\n';
            
            files.forEach(file => {
              comment += `- [${file}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            });
            
            comment += '\n### ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª:\n';
            comment += '1. Ø­Ù…Ù„ Ù…Ù„Ù APK Ù…Ù† Ø§Ù„Ù€ artifacts\n';
            comment += '2. ÙØ¹Ù‘Ù„ "ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"\n';
            comment += '3. Ø«Ø¨Øª APK Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ\n';
            comment += '4. Ø§Ø³ØªØ®Ø¯Ù… admin/1234 Ù„Ù„Ø¯Ø®ÙˆÙ„\n';
            comment += '5. Ø§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ·Ø¨ÙŠÙ‚ ÙÙ†Ø¯Ù‚ Ù…Ø§Ø±ÙŠÙ†Ø§! ğŸ¨\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  notify-success:
    name: Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡
    runs-on: ubuntu-latest
    needs: build-android-marina
    if: success()
    
    steps:
    - name: Success Notification
      run: |
        echo "ğŸ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Marina Hotel Android Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“± APK Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…"
        echo "ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: admin/1234"
        echo "ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø³Ù… Artifacts Ù„ØªØ­Ù…ÙŠÙ„ APK"

  notify-failure:
    name: Ø¥Ø´Ø¹Ø§Ø± ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
    runs-on: ubuntu-latest
    needs: build-android-marina
    if: failure()
    
    steps:
    - name: Failure Notification
      run: |
        echo "âŒ ÙØ´Ù„ Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Marina Hotel Android!"
        echo "ğŸ” ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"
        echo "ğŸ’¡ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©: Ø§Ù„ØªØ¨Ø¹ÙŠØ§ØªØŒ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ØŒ Ø£Ùˆ Ø¥ØµØ¯Ø§Ø± Java"