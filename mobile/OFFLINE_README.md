# Marina Hotel Mobile App - دعم العمل بدون إنترنت

## نظرة عامة
تطبيق فندق مارينا المحمول يدعم الآن العمل بدون إنترنت بالكامل! يمكنك إدارة الحجوزات والمدفوعات والمصروفات حتى عندما لا يتوفر اتصال بالإنترنت.

## 🔄 كيف يعمل النظام

### 1. قاعدة البيانات المحلية
- **SQLite**: قاعدة بيانات محلية تحتوي على جميع البيانات
- **مزامنة تلقائية**: عند توفر الإنترنت، تتم المزامنة تلقائياً
- **طابور المزامنة**: جميع التغييرات تُحفظ في طابور للمزامنة لاحقاً

### 2. خدمات الاتصال
- **فحص الاتصال**: مراقبة مستمرة لحالة الإنترنت
- **مزامنة ذكية**: مزامنة تلقائية كل 30 ثانية عند توفر الإنترنت
- **إعادة المحاولة**: إعادة محاولة المزامنة عند فشلها

### 3. واجهة المستخدم
- **مؤشر الحالة**: أيقونة في شريط التطبيق تظهر حالة الاتصال
- **شاشة المزامنة**: عرض تفصيلي لحالة المزامنة
- **إشعارات**: تنبيهات عند نجاح أو فشل المزامنة

## 📱 المميزات المتاحة بدون إنترنت

### ✅ الحجوزات
- إضافة حجوزات جديدة
- تعديل الحجوزات الموجودة
- عرض جميع الحجوزات
- البحث والفلترة
- فحص توفر الغرف

### ✅ المدفوعات
- تسجيل دفعات جديدة
- عرض تاريخ المدفوعات
- ربط المدفوعات بالحجوزات

### ✅ المصروفات
- إضافة مصروفات جديدة
- تصنيف المصروفات
- سحوبات الرواتب
- عرض الإحصائيات

### ✅ الغرف
- عرض حالة الغرف
- تحديث حالة الغرف
- فحص التوفر

### ✅ التقارير
- تقارير محلية
- إحصائيات أساسية
- تحليل البيانات المحلية

## 🔧 كيفية الاستخدام

### 1. التشغيل لأول مرة
```bash
# تثبيت التبعيات
flutter pub get

# تشغيل التطبيق
flutter run
```

### 2. العمل بدون إنترنت
1. **افتح التطبيق** - سيعمل حتى بدون إنترنت
2. **أضف البيانات** - جميع البيانات تُحفظ محلياً
3. **راقب المزامنة** - اضغط على أيقونة السحابة لمراقبة الحالة
4. **اتصل بالإنترنت** - ستتم المزامنة تلقائياً

### 3. مراقبة المزامنة
- **أيقونة خضراء**: متصل ومتزامن
- **أيقونة حمراء**: غير متصل
- **نقطة برتقالية**: جاري المزامنة

## 📊 شاشة حالة المزامنة

### معلومات الاتصال
- حالة الإنترنت (متصل/غير متصل)
- حالة المزامنة الحالية
- آخر وقت مزامنة

### إحصائيات المزامنة
- عدد العناصر في انتظار المزامنة
- عدد العناصر في الطابور
- معدل نجاح المزامنة

### طابور المزامنة
- قائمة بجميع العمليات المعلقة
- تفاصيل كل عملية
- حالة المحاولات وأي أخطاء

### إجراءات المزامنة
- **مزامنة يدوية**: إجبار المزامنة فوراً
- **مسح البيانات**: حذف جميع البيانات المحلية
- **إعادة تعيين**: العودة للحالة الافتراضية

## 🗄️ بنية قاعدة البيانات المحلية

### الجداول الرئيسية
```sql
-- الحجوزات
bookings (
  id, server_id, guest_name, guest_phone, room_number,
  checkin_date, checkout_date, status, is_synced, sync_action
)

-- الغرف
rooms (
  id, server_id, room_number, type, price, status, is_synced
)

-- المدفوعات
payments (
  id, server_id, booking_id, amount, payment_method,
  payment_date, is_synced
)

-- المصروفات
expenses (
  id, server_id, expense_type, description, amount,
  date, is_synced
)

-- طابور المزامنة
sync_queue (
  id, table_name, record_id, action, data,
  retry_count, last_error
)
```

### حقول المزامنة
- **server_id**: معرف السجل على الخادم
- **is_synced**: هل تم مزامنة السجل (0/1)
- **sync_action**: نوع العملية (create/update/delete)

## 🔄 عملية المزامنة

### 1. المزامنة التلقائية
```dart
// كل 30 ثانية عند توفر الإنترنت
Timer.periodic(Duration(seconds: 30), (timer) {
  if (isOnline && !isSyncing) {
    syncData();
  }
});
```

### 2. رفع البيانات المحلية
1. جلب العناصر من طابور المزامنة
2. رفع كل عنصر للخادم
3. تحديث حالة المزامنة
4. حذف العنصر من الطابور عند النجاح

### 3. تحديث البيانات المرجعية
1. جلب الغرف من الخادم
2. جلب الموظفين والموردين
3. تحديث البيانات المحلية
4. الحفاظ على التغييرات المحلية

## ⚠️ أمور مهمة

### 1. إدارة التعارضات
- **أولوية للبيانات المحلية**: التغييرات المحلية لها الأولوية
- **دمج ذكي**: دمج البيانات الجديدة من الخادم
- **تجنب الكتابة فوق البيانات**: حماية البيانات المحلية غير المتزامنة

### 2. حدود الذاكرة
- **حد أقصى للسجلات**: 10,000 سجل لكل جدول
- **تنظيف دوري**: حذف البيانات القديمة تلقائياً
- **ضغط البيانات**: تحسين استخدام المساحة

### 3. الأمان
- **تشفير البيانات الحساسة**: كلمات المرور والمعلومات الشخصية
- **نسخ احتياطية**: نسخ احتياطية دورية للبيانات المحلية
- **استرداد البيانات**: إمكانية استرداد البيانات عند الفقدان

## 🛠️ استكشاف الأخطاء

### مشاكل شائعة وحلولها

#### 1. فشل المزامنة
```
الأعراض: البيانات لا تتزامن مع الخادم
الحلول:
- تحقق من الاتصال بالإنترنت
- راجع شاشة حالة المزامنة
- جرب المزامنة اليدوية
- أعد تشغيل التطبيق
```

#### 2. بطء التطبيق
```
الأعراض: التطبيق بطيء في الاستجابة
الحلول:
- امسح البيانات القديمة
- أعد تعيين قاعدة البيانات
- تحقق من مساحة التخزين
```

#### 3. فقدان البيانات
```
الأعراض: اختفاء بعض البيانات
الحلول:
- تحقق من طابور المزامنة
- راجع سجل الأخطاء
- استعد النسخة الاحتياطية
```

### أدوات التشخيص

#### 1. شاشة حالة المزامنة
- عرض تفصيلي لحالة النظام
- إحصائيات المزامنة
- سجل الأخطاء

#### 2. سجلات التطبيق
```dart
// تفعيل السجلات التفصيلية
if (kDebugMode) {
  print('Sync status: $syncStatus');
  print('Queue length: $queueLength');
}
```

#### 3. فحص قاعدة البيانات
```sql
-- فحص البيانات غير المتزامنة
SELECT * FROM bookings WHERE is_synced = 0;
SELECT * FROM sync_queue ORDER BY created_at DESC;
```

## 🔮 التطوير المستقبلي

### مميزات مخططة
- [ ] مزامنة تدريجية (Delta Sync)
- [ ] ضغط البيانات المتقدم
- [ ] مزامنة في الخلفية
- [ ] إشعارات المزامنة
- [ ] تحليلات الاستخدام
- [ ] نسخ احتياطية سحابية

### تحسينات الأداء
- [ ] فهرسة قاعدة البيانات
- [ ] تحسين استعلامات SQL
- [ ] تحميل البيانات بالطلب
- [ ] ذاكرة التخزين المؤقت الذكية

## 📞 الدعم والمساعدة

### للمطورين
- راجع الكود المصدري في `lib/services/`
- اقرأ التعليقات في الكود
- جرب الأمثلة في `examples/`

### للمستخدمين
- استخدم شاشة حالة المزامنة
- راجع الإشعارات والرسائل
- تواصل مع فريق الدعم عند الحاجة

---

**تم تطويره بـ ❤️ لفندق مارينا**

*يعمل بدون إنترنت، يتزامن عند الاتصال!*
